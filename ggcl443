#!/bin/bash

PORT=443
USERNAME="user$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 6)"
PASSWORD="$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16)"
INTERFACE=$(ip route get 1 | awk '{print $5; exit}')

if ! command -v danted &> /dev/null; then
    echo "üõ†Ô∏è C√†i Dante SOCKS5..."
    sudo apt update && sudo apt install -y dante-server curl nano
fi

cat <<EOF | sudo tee /etc/danted.conf > /dev/null
logoutput: /var/log/sockd.log
internal: 0.0.0.0 port = $PORT
external: $INTERFACE
method: username
user.privileged: root
user.notprivileged: nobody
user.libwrap: nobody
client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect
}
socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    command: connect
    log: connect disconnect
}
EOF

sudo useradd -M -s /usr/sbin/nologin "$USERNAME"
echo "$USERNAME:$PASSWORD" | sudo chpasswd

if command -v ufw &>/dev/null; then
    sudo ufw allow $PORT/tcp
else
    sudo iptables -C INPUT -p tcp --dport $PORT -j ACCEPT 2>/dev/null || \
    sudo iptables -I INPUT -p tcp --dport $PORT -j ACCEPT
fi

sudo touch /var/log/sockd.log
sudo chown nobody:nogroup /var/log/sockd.log
sudo systemctl restart danted
sudo systemctl enable danted

IP=$(curl -s https://api.ipify.org)

echo "üß™ ƒêang ki·ªÉm tra ho·∫°t ƒë·ªông proxy..."
sleep 2
TEST=$(curl -x socks5h://$USERNAME:$PASSWORD@127.0.0.1:$PORT -s --max-time 5 https://api.myip.com)

PROXY="$IP:$PORT:$USERNAME:$PASSWORD"

if [[ $TEST == *"$IP"* ]]; then
    echo
    echo "‚úÖ SOCKS5 Proxy ƒë√£ s·∫µn s√†ng!"
    echo "----------------------------"
    echo "  IP      : $IP"
    echo "  Port    : $PORT"
    echo "  Username: $USERNAME"
    echo "  Password: $PASSWORD"
    echo "----------------------------"
    echo "üìå D·∫°ng: $PROXY"
    echo "$PROXY" | sudo tee /root/socks5_proxy.txt > /dev/null
else
    echo "‚ùå Proxy kh√¥ng ho·∫°t ƒë·ªông. Ki·ªÉm tra l·∫°i c·∫•u h√¨nh ho·∫∑c firewall."
fi

CHECK_SCRIPT="/usr/local/bin/check_socks5.sh"
cat <<EOF | sudo tee $CHECK_SCRIPT > /dev/null
#!/bin/bash
HOST="$IP"
PORT="$PORT"
USER="$USERNAME"
PASS="$PASSWORD"

timeout 5 curl --socks5 \$USER:\$PASS@127.0.0.1:\$PORT https://ifconfig.me >/dev/null 2>&1

if [ \$? -ne 0 ]; then
  echo "[!] Proxy l·ªói l√∫c \$(date). ƒêang restart danted..."
  systemctl restart danted
else
  echo "[OK] Proxy ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng l√∫c \$(date)."
fi
EOF

sudo chmod +x "$CHECK_SCRIPT"
echo
echo "[+] Script ki·ªÉm tra proxy ƒë√£ t·∫°o: $CHECK_SCRIPT"
echo "[+] G·ª£i √Ω th√™m cronjob ki·ªÉm tra m·ªói 5 ph√∫t:"
echo "    */5 * * * * root $CHECK_SCRIPT"
