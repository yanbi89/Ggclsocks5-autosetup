#!/bin/bash

# âš™ï¸ Port
PORT=443

# ğŸ” Táº¡o user vÃ  password ngáº«u nhiÃªn
USERNAME="user$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 6)"
PASSWORD="$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16)"

# ğŸŒ Láº¥y interface máº¡ng thá»±c táº¿
INTERFACE=$(ip route get 1 | awk '{print $5; exit}')

# ğŸ§± CÃ i Dante náº¿u chÆ°a cÃ³
if ! command -v danted &> /dev/null; then
    echo "ğŸ› ï¸ CÃ i Dante SOCKS5..."
    sudo apt update && sudo apt install -y dante-server curl nano
fi

# ğŸ§¾ Táº¡o cáº¥u hÃ¬nh
cat <<EOF | sudo tee /etc/danted.conf > /dev/null
logoutput: /var/log/sockd.log
internal: 0.0.0.0 port = $PORT
external: $INTERFACE

method: username

user.privileged: root
user.notprivileged: nobody
user.libwrap: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect
}

socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    command: connect
    log: connect disconnect
}
EOF

# ğŸ‘¤ Táº¡o user SOCKS5
sudo useradd -M -s /usr/sbin/nologin "$USERNAME"
echo "$USERNAME:$PASSWORD" | sudo chpasswd

# ğŸ›¡ï¸ Má»Ÿ port
if command -v ufw &>/dev/null; then
    sudo ufw allow $PORT/tcp
else
    sudo iptables -C INPUT -p tcp --dport $PORT -j ACCEPT 2>/dev/null || \
    sudo iptables -I INPUT -p tcp --dport $PORT -j ACCEPT
fi

# ğŸ“œ Log file
sudo touch /var/log/sockd.log
sudo chown nobody:nogroup /var/log/sockd.log

# ğŸ” Restart & enable Dante
sudo systemctl restart danted
sudo systemctl enable danted

# ğŸŒ Láº¥y IP cÃ´ng cá»™ng
IP=$(curl -s https://api.ipify.org)

# ğŸ§ª Kiá»ƒm tra hoáº¡t Ä‘á»™ng proxy
echo "ğŸ§ª Äang kiá»ƒm tra hoáº¡t Ä‘á»™ng proxy..."
sleep 2
TEST=$(curl -x socks5h://$USERNAME:$PASSWORD@127.0.0.1:$PORT -s --max-time 5 https://api.myip.com)

# âœ… Hoáº·c âŒ Hiá»ƒn thá»‹ káº¿t quáº£
PROXY="$IP:$PORT:$USERNAME:$PASSWORD"

if [[ $TEST == *"$IP"* ]]; then
    echo
    echo "âœ… SOCKS5 Proxy Ä‘Ã£ sáºµn sÃ ng!"
    echo "----------------------------"
    echo "  IP      : $IP"
    echo "  Port    : $PORT"
    echo "  Username: $USERNAME"
    echo "  Password: $PASSWORD"
    echo "----------------------------"
    echo "ğŸ“Œ Dáº¡ng: $PROXY"
    echo "$PROXY" | sudo tee /root/socks5_proxy.txt > /dev/null
else
    echo "âŒ Proxy khÃ´ng hoáº¡t Ä‘á»™ng. Kiá»ƒm tra láº¡i cáº¥u hÃ¬nh hoáº·c firewall."
fi

# ğŸ§ª Táº¡o script kiá»ƒm tra tá»± Ä‘á»™ng
CHECK_SCRIPT="/usr/local/bin/check_socks5.sh"
cat <<EOF | sudo tee $CHECK_SCRIPT > /dev/null
#!/bin/bash
HOST="$IP"
PORT="$PORT"
USER="$USERNAME"
PASS="$PASSWORD"

timeout 5 curl --socks5 \$USER:\$PASS@127.0.0.1:\$PORT https://ifconfig.me >/dev/null 2>&1

if [ \$? -ne 0 ]; then
  echo "[!] Proxy lá»—i lÃºc \$(date). Äang restart danted..."
  systemctl restart danted
else
  echo "[OK] Proxy hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng lÃºc \$(date)."
fi
EOF

sudo chmod +x "$CHECK_SCRIPT"

echo
echo "[+] Script kiá»ƒm tra proxy Ä‘Ã£ táº¡o: $CHECK_SCRIPT"
echo "[+] Gá»£i Ã½ thÃªm cronjob kiá»ƒm tra má»—i 5 phÃºt:"
echo "    */5 * * * * root $CHECK_SCRIPT"
